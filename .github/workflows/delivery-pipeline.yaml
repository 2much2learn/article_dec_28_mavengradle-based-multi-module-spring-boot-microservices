name: Delivery Pipeline

on:
  push:
    branches:
      - feature-ms-carlosLopez-pipelinedelivery

jobs:

  run-unit-tests:
    name: Run Tests ðŸ§ª
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        id: running-tests
        uses: actions/checkout@v3.5.3
          
      - name: Run Tests
        run: |
          chmod +x gradlew
          ./gradlew test
    
  scan-vulnerabilities:
    name: Vulnerabilities scanner ðŸ§¨
    runs-on: ubuntu-latest
    needs: [run-unit-tests]
    steps:
      - name: Checkout
        id: running-tests
        uses: actions/checkout@v3.5.3

      - name: Analisis SonarCloud
        run: |
          chmod +x gradlew
          ./gradlew build sonar -Dsonar.token=${{ secrets.SONAR_TOKEN }}
  
  deploy-on-k8s:
    name: Build docker image ðŸ‘¾
    runs-on: ubuntu-latest
    needs: [run-unit-tests, scan-vulnerabilities]
    steps:
      
      - name: CheckoutðŸš€
        uses: actions/checkout@v3.5.3
      
      - uses: actions/checkout@v2
      - name: Start minikube
        
        uses: medyagh/setup-minikube@master
      - name: Get pods
        run: kubectl get pods -A

      - name: Deploy apps
        run: |
          ls -lhart
          kubectl apply -f k8s
      
      - name : Check Deployments
        run: |
          chmod +x ./scripts/wait-pod
          ./scripts/wait-pod
          minikube service list
          kubectl port-forward service/springboot-service-a 8081:8080
          curl http://localhost:8081/greeting