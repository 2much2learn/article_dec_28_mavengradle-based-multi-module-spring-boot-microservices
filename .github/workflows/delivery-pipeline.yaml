name: Delivery Pipeline

on:
  push:
    branches:
      - feature-ms-carlosLopez-pipelinedelivery

jobs:

  run-unit-tests:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        id: running-tests
        uses: actions/checkout@v3.5.3
    
      - name: Run Tests
        run: |
          chmod +x gradlew
          ./gradlew test

  scan-vulnerabilities:
    name: Vulnerabilities scanner
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        id: running-tests
        uses: actions/checkout@v3.5.3

      - name: Run SonarCloud tests
        id: running-sonarcloud-test
        run: |
            chmod +x gradlew
            ./gradlew build sonar -Dsonar.token=${{ secrets.SONAR_TOKEN }}

  deploy-on-k8s:
    name: Build docker image
    runs-on: ubuntu-latest
    needs: [run-unit-tests]
    steps:
      
      - name: CheckoutðŸš€
        uses: actions/checkout@v3.5.3
      
      # now you can run kubectl to see the pods in the cluster
      - uses: actions/checkout@v2
      - name: Start minikube
        
        uses: medyagh/setup-minikube@master
      - name: Try the cluster !
        run: kubectl get pods -A

      - name: deploy apps
        run: |
          ls -lhart
          kubectl apply -f k8s
      
      - name : test endpoint
        run: |
          chmod +x ./scripts/wait-pod
          ./scripts/wait-pod
          minikube service springboot-service-a --url
          echo "------------------opening the service------------------"
          curl $(minikube service springboot-service-a --url)  
