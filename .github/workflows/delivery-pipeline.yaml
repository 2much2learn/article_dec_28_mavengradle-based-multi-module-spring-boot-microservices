name: Delivery Pipeline

on:
  push:
    branches:
      - feature-ms-carlosLopez-pipelinedelivery

jobs:

  run-unit-tests:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        id: running-tests
        uses: actions/checkout@v3.5.3
    
      - name: Run Tests
        run: |
          chmod +x gradlew
          ./gradlew test
      
  build-java-project:
    name: Build java project
    runs-on: ubuntu-latest
    needs: 
      - run-unit-tests
    steps:
      - name: CheckoutðŸš€
        uses: actions/checkout@v3.5.3

      - name: Setup JAVA JDK
        uses: actions/setup-java@v3.12.0
        with:
          java-version: '11'
          distribution: 'zulu'

      - name: Compile Gradle
        id: compile-gradle
        run: |
          chmod +x gradlew
          ./gradlew build
          mkdir -p /tmp
          mv service-a/build/libs/service-b-0.0.1-SNAPSHOT.jar /tmp
          mv service-b/build/libs/service-b-0.0.1-SNAPSHOT.jar /tmp
          mv service-c/build/libs/service-c-0.0.1-SNAPSHOT.jar /tmp
      
      - name: Upload JARs
        uses: actions/upload-artifact@v3.1.2
        with:
          name: build
          path: /tmp

  docker-build:
    name: Build docker image
    outputs:
      full_docker_image_tag: '${{ steps.build_image.outputs.full_docker_image_tag }}'
      image_tag: '${{ steps.build_image.outputs.image_tag }}'
    runs-on: ubuntu-latest
    needs: [run-unit-tests,build-java-project]
    steps:
    
      - name: Add SHORT_SHA and BRANCH_TAG env variables
        run: |
          echo "SHORT_SHA=`echo ${GITHUB_SHA} | cut -c1-8`" >> $GITHUB_ENV
          echo "BRANCH_TAG=`echo ${GITHUB_REF##*/}`" >> $GITHUB_ENV

      - name: Set IMAGE_TAG env variable
        run: |
          echo "IMAGE_TAG=`echo ${BRANCH_TAG}-${SHORT_SHA}`" >> $GITHUB_ENV

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
            name: build
            path: /tmp

      - name: List files
        run: |
          ls -R
        working-directory: /tmp

      # - name: Build and tag image
      #   id: build_image
      #   env:
      #     REGISTRY: 'hub.docker.com'
      #     IMAGE_NAME: 'delivery-pipeline-devops-foundation'
      #     IMAGE_TAG: ${{ env.IMAGE_TAG }}
      #   run: |
      #     echo REGISTRY: $REGISTRY
      #     echo IMAGE_TAG: $IMAGE_TAG
      #     echo "Building and tagging $REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG ..."
      #     docker build -t $REGISTRY/$IMAGE_NAME:$IMAGE_TAG -f Dockerfile .