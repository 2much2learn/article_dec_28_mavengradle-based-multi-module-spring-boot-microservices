name: Delivery Pipeline

on:
  push:
    branches:
      - feature-ms-carlosLopez-pipelinedelivery

jobs:

  run-unit-tests:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        id: running-tests
        uses: actions/checkout@v3.5.3
    
      - name: Run Tests
        run: |
          chmod +x gradlew
          ./gradlew test

  build-java-project:
    name: Build java project
    runs-on: ubuntu-latest
    needs: 
      - run-unit-tests
    steps:
      - name: CheckoutðŸš€
        uses: actions/checkout@v3.5.3

      - name: Setup JAVA JDK
        uses: actions/setup-java@v3.12.0
        with:
          java-version: '11'
          distribution: 'zulu'

      - name: Compile Gradle
        id: compile-gradle
        run: |
          chmod +x gradlew
          ./gradlew build
  
  docker-build:
    name: Build docker image
    outputs:
      full_docker_image_tag: '${{ steps.build_image.outputs.full_docker_image_tag }}'
      image_tag: '${{ steps.build_image.outputs.image_tag }}'
    runs-on: ubuntu-latest
    needs: [run-unit-tests,build-java-project]
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
    
      - name: Add SHORT_SHA and BRANCH_TAG env variables
        run: |
          echo "SHORT_SHA=`echo ${GITHUB_SHA} | cut -c1-8`" >> $GITHUB_ENV
          echo "BRANCH_TAG=`echo ${GITHUB_REF##*/}`" >> $GITHUB_ENV

      - name: Set IMAGE_TAG env variable
        run: |
          echo "IMAGE_TAG=`echo ${BRANCH_TAG}-${SHORT_SHA}`" >> $GITHUB_ENV

      - name: Build and tag image
        id: build_image
        env:
          REGISTRY: 'hub.docker.com'
          IMAGE_NAME: 'delivery-pipeline-devops-foundation'
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          gradle clean build bootBuildImage